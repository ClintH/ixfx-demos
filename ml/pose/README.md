# ml

Acronyms
* ML: Machine Learning
* TF: TensorFlow

# Architecture

A _sender_ sketch reads data from a source (webcam, video, or recorded points) and emits it via [Remote](https://github.com/clinth/remote)

This sketch shouldn't need to be modified, but it is how some Tensorflow settings can be tweaked. In `pose/head`, we show how to embed the source in the page via an `IFRAME`. The downside of this is that with every little change in your code, the sender has to also reload - and this can be cumbersome when we are accessing media.

Instead, the idea is to open the sender sketch in a separate window and leave it running. Note that if you minimise or cover it over with another window too much, the browser may suspend Javascript execution (as a battery-saving mechanism).

Tip: There are tools for Windows & Mac to make any window stay on top of all other windows.

Your sketch receives pose data from the sender. If you're running the same browser, this will be very fast and data never leaves your machine. You can activate Remote's network capabilities (see [readme](../_readmes/websockets.md)) to run the sender/receiver on separate machines. Or even multiples of them!

In your own sketch, you can import stuff relating to MoveNet via:

```js
import * as MoveNet from "../Poses.js";
```

...assuming your sketch is located at `ixfx-demos/ml/pose/YOUR-SKETCH` and thus accessible via _http://localhost:5555/ml/pose/YOUR-SKETCH_

If your sketch is in the top-level of the `ixfx-demos` directory (ie. `ixfx-demos/YOUR-SKETCH` and via _http://localhost:5555/YOUR-SKETCH_), this import ought to work:

```js
import * as MoveNet from "./ml/pose/Poses.js";
```

## Pose ids

Pose ids are generated when TF starts tracking a body. If it loses tracking, the same human body might get assigned a new id. Ids are generated by the sender sketch. Since there could be multiple senders, we can't use the pose id to properly separate poses. Thus, we use a 'guid' (globally-unique id). This consists of the sender's id and the pose id. If the sender's id is '407-33', and the pose id is 1, the guid of that pose will be '407-33-1'.

# PosesTracker

`PosesTracker` helps you to manage multiple poses being sent by (theoretically) multiple sources. Each pose is tracked via `PoseTracker`, allowing you to review the history of each keypoint of a pose.

To create:
```js
const poses = new MoveNet.PosesTracker();
```

TIP: In this readme, if we use the variable `poses`, it refers to an instance of `PosesTracker`.

You can provide some options to override the default behaviour. The options are:
```js
// Remove a pose if it hasn't been seen for this long
maxAgeMs: 10_000,
// Reset keypoint tracker after this many samples/
// 0 disables
resetAfterSamples: 0,
// How many samples to store if 'storeIntermediate' is enabled
sampleLimit: 100,
// Whether to store data for each pose keypoint
storeIntermediate:false
```

For example:

```js
const poses = new MoveNet.PosesTracker({
  // Remove a pose if we haven't seen it for 30seconds
  maxAge: 30_1000
})
```

The tracker has two events, `expired` and `added` to notify when a new pose is seen or a pose removed due to expiry.

```js
poses.events.addEventListener(`expired`, event => { 
  const poseTracker = event.detail;
  console.log(`Pose expired: ${poseTracker.guid}`);
});

poses.events.addEventListener(`added`, event => {
  const poseTracker = event.detail;
  console.log(`Pose added: ${poseTracker.guid}`);
});
```

## Adding

To use it, call `seen`, passing the id of the sender, and the pose. For example:

```js
remote.onData = (packet) {
  const { _from, data } = packet;
  const poseData =/** @type Types.Pose[] */(data);
  for (const pose of poseData) {
    settings.poses.seen(_from, pose);
  }
};
```

## Enumerating data

* Get all the trackers from a particular sender: `getFromSender(senderId)`
* Get all sender ids: `getSenderIds`
* Get all raw pose data regardless of sender: `getRawPoses` (`getRawPosesByAge` sorts by last updated)
* Get all trackers, regardless of sender: `get` 
* Get all trackers, sorted by age: `getByAge` (position 0 is most recently updated pose)
* Get all trackers, sorted by score: `getByScore` (position 0 is highest-ranked score)
* Get all trackers, sorted by horizontal position `getByHorizontal` (position 0 is the left-most pose)

Example:
```js
for (const tracker of poses.getFromSender(senderId)) {
  // Process all poses from each sender
  // Since we have the tracker, we can do low-level work with keypoints
}

for (const pose of poses.getRawPosesByAge()) {
  // Process all poses, sorted by age
  // This is the raw, last received pose without any additional history
}
```

## Accessing a particular pose

Since we may have multiple senders which may have overlapping pose ids, to access a pose, we need the sender's id as well as the pose id.

Use `getByGuid(guid)` to get the tracker, or `getRawPoseByGuid` to get the raw pose data.
```js
// Get the corresponding tracker
const trackerForPose = poses.getByGuid(`902-42-10`);
// Get the last raw pose data
const poseData = poses.getRawPoseByGuid(`902-42-10`);
```

If we don't have the sender id for some reason, or if you can be sure there's only one sender, you can get a pose by it's id with `getByPoseId`. This returns a `PoseTracker` instance.

```js
// Get the corresponding tracker
const trackerForPose = poses.getByPoseId(`10`);
// Get the last raw pose data
const poseData = poses.getRawPoseByPoseId(`10`);
```

# PoseTracker

`PosesTracker` keeps track of all poses, `PoseTracker` keeps track of a keypoints for a single pose. It maintains a PointsTracker per keypoint.

Fields
* `hue`: randomly-assigned hue for this pose (0..360)
* `guid`: globally-unique id for pose (consisting of sender id and pose id)
* `fromId`: sender id
* `poseId`: original pose id (warning: potentially conflicting with other pose ids if we have several senders)

Example
```js
const hsl = `hsl${pose.hue},50%,50%}`;
```

## Accessing keypoints

To get the [PointTracker](https://clinth.github.io/ixfx-docs/data/trackers/#point) for a keypoint:

```js
const noseTracker = pose.keypoint(`nose`); // PointTracker
```

Once we have the point tracker, there are _a lot_ of things to access:
```js
noseTracker.angleFromStart();
noseTracker.distanceFromStart();
noseTracker.difference(); // x&y difference from last and start
noseTracker.lineStartEnd; // {a,y} - Line from start to end
noseTracker.x;  // Last x coordinate
noseTracker.y;  // Last y coordinate

// Movement vectors
noseTracker.vectorCartesian;
noseTracker.vectorPolar;

noseTracker.elapsed;
noseTracker.initial; // {x,y}
noseTracker.last;    // {x,y,timestamp}
noseTracker.length; // Number of points - not distance!
// Last computed results
noseTracker.lastResult // {fromInitial,fromLast,values}
```

To get the raw value:
```js
const nosePoint = pose.keypointValue(`nose`); // {x,y}
```

To get raw keypoints across all poses:
```js
for (const kp of poses.getRawKeypoints(`nose`)) {
  // {x,y,score,name}
}
```

## Raw poses

If you have a raw pose, keypoints are stored as a numbered array. To access a keypoint by name:
```js
const nose = MoveNet.Coco.getKeypoint(rawPose, `nose`); // {x,y,name,score}
```

To loop over keypoints:
```js
for (const kp of rawPose.keypoints) {
  // {x,y,name,score}
}

```
# Recording

* Point data is recorded to the browser's local storage. Image data is are not stored.

# Utility

A few utility functions are available when importing:
```js
import * as MoveNet from "../Poses.js";
```


Sort array of poses horizontally:
```js
const sorted = MoveNet.horizontalSort(poses);
```

Get centroid of pose (including all keypoints):
```js
const centroid = MoveNet.centroid(pose); // {x,y}
```

Return a line between two named points. If either of the points is not found, _undefined_ is returned. This is useful for using with ixfx's Line module.
```js
const line = MoveNet.lineBetween(pose, `left_shoulder`, `right_shoulder`);
// { a: { x, y }, b: { x, y } }
```

Gets the center based on the torso (between shoulders and hips). If
any of the needed points is not found, _undefined_ is returned.
```js
const c = MoveNet.roughCenter(pose); // { x, y }
```

# Troubleshooting

## https

Your code will not be able to access media devices like a camera if it's being loaded from an insecure connection.

If you're running a local server, make sure you're using http://127.0.0.1 as the address. If you're running from an online hosting service, make sure you're accessing via `https://`.
